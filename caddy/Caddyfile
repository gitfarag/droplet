# dash-dev
dash-dev.{$DOMAIN_NAME:domain.invalid} {
    # Define Cloudflare's IPs as a match group for dash-dev
    @cloudflare_dash {
        remote_ip 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 104.16.0.0/13 104.24.0.0/14 108.162.192.0/18 131.0.72.0/22 141.101.64.0/18 162.158.0.0/15 172.64.0.0/13 173.245.48.0/20 188.114.96.0/20 190.93.240.0/20 197.234.240.0/22 198.41.128.0/17
    }
    # Handle Cloudflare traffic over HTTP (don't redirect to HTTPS)
    handle @cloudflare_dash {
        reverse_proxy frontend:80
    }

    # Handle other traffic (non-Cloudflare) and force HTTPS
    @no_https_redirect_dash {
        not remote_ip 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 104.16.0.0/13 104.24.0.0/14 108.162.192.0/18 131.0.72.0/22 141.101.64.0/18 162.158.0.0/15 172.64.0.0/13 173.245.48.0/20 188.114.96.0/20 190.93.240.0/20 197.234.240.0/22 198.41.128.0/17
    }

    handle @no_https_redirect_dash {
        redir https://{host}{uri}
    }
}

# api
api-dev.{$DOMAIN_NAME:domain.invalid} {
    # Define Cloudflare's IPs as a match group for api-dev
    @cloudflare_api {
        remote_ip 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 104.16.0.0/13 104.24.0.0/14 108.162.192.0/18 131.0.72.0/22 141.101.64.0/18 162.158.0.0/15 172.64.0.0/13 173.245.48.0/20 188.114.96.0/20 190.93.240.0/20 197.234.240.0/22 198.41.128.0/17
    }
    # Handle Cloudflare traffic over HTTP (don't redirect to HTTPS)
    handle @cloudflare_api {
        reverse_proxy api:4004
    }

    # Handle other traffic (non-Cloudflare) and force HTTPS
    @no_https_redirect_api {
        not remote_ip 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 104.16.0.0/13 104.24.0.0/14 108.162.192.0/18 131.0.72.0/22 141.101.64.0/18 162.158.0.0/15 172.64.0.0/13 173.245.48.0/20 188.114.96.0/20 190.93.240.0/20 197.234.240.0/22 198.41.128.0/17
    }

    handle @no_https_redirect_api {
        redir https://{host}{uri}
    }

    header {
        -X-Powered-By
        -Server

        # enable HSTS
        Strict-Transport-Security max-age=31536000;

        # disable clients from sniffing the media type
        X-Content-Type-Options nosniff

        # clickjacking protection
        X-Frame-Options DENY

        # XSS Protection
        X-XSS-Protection "1; mode=block"
    }

    rate_limit {
        # limit requests based on IP address
        zone api_limit {
            key {http.request.header.CF-Connecting-IP}
            events 100
            window 1m
        }

        zone burst_limit {
            key {http.request.header.CF-Connecting-IP}
            events 20
            window 1s
        }
    }
}

# jenkins
pipe-dev.{$DOMAIN_NAME:domain.invalid} {
    # Define Cloudflare's IPs as a match group for pipe-dev
    @cloudflare_jenkins {
        remote_ip 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 104.16.0.0/13 104.24.0.0/14 108.162.192.0/18 131.0.72.0/22 141.101.64.0/18 162.158.0.0/15 172.64.0.0/13 173.245.48.0/20 188.114.96.0/20 190.93.240.0/20 197.234.240.0/22 198.41.128.0/17
    }
    # Handle Cloudflare traffic over HTTP (don't redirect to HTTPS)
    handle @cloudflare_jenkins {
        reverse_proxy jenkins:8080
    }

    # Handle other traffic (non-Cloudflare) and force HTTPS
    @no_https_redirect_jenkins {
        not remote_ip 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 104.16.0.0/13 104.24.0.0/14 108.162.192.0/18 131.0.72.0/22 141.101.64.0/18 162.158.0.0/15 172.64.0.0/13 173.245.48.0/20 188.114.96.0/20 190.93.240.0/20 197.234.240.0/22 198.41.128.0/17
    }

    handle @no_https_redirect_jenkins {
        redir https://{host}{uri}
    }

    header {
        Strict-Transport-Security "max-age=31536000"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        X-Forwarded-Proto {http.request.scheme}
        X-Forwarded-Host {http.request.host}
    }
}
