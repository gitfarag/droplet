# dash-dev
dash-dev.{$DOMAIN_NAME:domain.invalid} {
    # Handle Cloudflare traffic (allow HTTP, no redirect)
    @cloudflare {
        remote_ip 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 104.16.0.0/13 104.24.0.0/14 108.162.192.0/18 131.0.72.0/22 141.101.64.0/18 162.158.0.0/15 172.64.0.0/13 173.245.48.0/20 188.114.96.0/20 190.93.240.0/20 197.234.240.0/22 198.41.128.0/17
    }
    handle @cloudflare {
        reverse_proxy frontend:80
    }

    # Force redirect to HTTPS for non-Cloudflare traffic
    @not_cloudflare {
        not remote_ip 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 104.16.0.0/13 104.24.0.0/14 108.162.192.0/18 131.0.72.0/22 141.101.64.0/18 162.158.0.0/15 172.64.0.0/13 173.245.48.0/20 188.114.96.0/20 190.93.240.0/20 197.234.240.0/22 198.41.128.0/17
    }
    handle @not_cloudflare {
        redir https://{host}{uri} permanent
    }
}

# api-dev
api-dev.{$DOMAIN_NAME:domain.invalid} {
    # Handle Cloudflare traffic (allow HTTP, no redirect)
    @cloudflare {
        remote_ip 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 104.16.0.0/13 104.24.0.0/14 108.162.192.0/18 131.0.72.0/22 141.101.64.0/18 162.158.0.0/15 172.64.0.0/13 173.245.48.0/20 188.114.96.0/20 190.93.240.0/20 197.234.240.0/22 198.41.128.0/17
    }
    handle @cloudflare {
        reverse_proxy api:4004
    }

    # Force redirect to HTTPS for non-Cloudflare traffic
    @not_cloudflare {
        not remote_ip 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 104.16.0.0/13 104.24.0.0/14 108.162.192.0/18 131.0.72.0/22 141.101.64.0/18 162.158.0.0/15 172.64.0.0/13 173.245.48.0/20 188.114.96.0/20 190.93.240.0/20 197.234.240.0/22 198.41.128.0/17
    }
    handle @not_cloudflare {
        redir https://{host}{uri} permanent
    }

    header {
        -X-Powered-By
        -Server
        Strict-Transport-Security max-age=31536000;
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
    }

    rate_limit {
        zone api_limit {
            key {http.request.header.CF-Connecting-IP}
            events 100
            window 1m
        }

        zone burst_limit {
            key {http.request.header.CF-Connecting-IP}
            events 20
            window 1s
        }
    }
}

# pipe-dev (Jenkins)
pipe-dev.{$DOMAIN_NAME:domain.invalid} {
    # Handle Cloudflare traffic (allow HTTP, no redirect)
    @cloudflare {
        remote_ip 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 104.16.0.0/13 104.24.0.0/14 108.162.192.0/18 131.0.72.0/22 141.101.64.0/18 162.158.0.0/15 172.64.0.0/13 173.245.48.0/20 188.114.96.0/20 190.93.240.0/20 197.234.240.0/22 198.41.128.0/17
    }
    handle @cloudflare {
        reverse_proxy jenkins:8080
    }

    # Force redirect to HTTPS for non-Cloudflare traffic
    @not_cloudflare {
        not remote_ip 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 104.16.0.0/13 104.24.0.0/14 108.162.192.0/18 131.0.72.0/22 141.101.64.0/18 162.158.0.0/15 172.64.0.0/13 173.245.48.0/20 188.114.96.0/20 190.93.240.0/20 197.234.240.0/22 198.41.128.0/17
    }
    handle @not_cloudflare {
        redir https://{host}{uri} permanent
    }

    header {
        Strict-Transport-Security "max-age=31536000"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        X-Forwarded-Proto {http.request.scheme}
        X-Forwarded-Host {http.request.host}
    }
}

